<!DOCTYPE html>
<html lang="fr">
<head>

  <meta charset="utf-8" />

  
  <title>
    vonKrafft | Un simple site en PHP avec Docker et Nginx
</title>

  
  




  
  <meta name="author" content="vonKrafft" />
  <meta name="description" content="J&amp;rsquo;ai récemment revu l&amp;rsquo;organisation des containers Docker présents sur mon serveur et j&amp;rsquo;ai essayé d&amp;rsquo;utiliser le plus possible les images &amp;ldquo;officielles&amp;rdquo; des technos dont j&amp;rsquo;avais besoin. Ici, nous allons mettre en place un Nginx pour servir des pages statique (HTML et autres ressources) mais également en mesure de gérer du contenu PHP.

" />

  
  
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:site" content="@v0nkrafft" />
    <meta name="twitter:title" content="Un simple site en PHP avec Docker et Nginx" />
    <meta name="twitter:description" content="J&amp;rsquo;ai récemment revu l&amp;rsquo;organisation des containers Docker présents sur mon serveur et j&amp;rsquo;ai essayé d&amp;rsquo;utiliser le plus possible les images &amp;ldquo;officielles&amp;rdquo; des technos dont j&amp;rsquo;avais besoin. Ici, nous allons mettre en place un Nginx pour servir des pages statique (HTML et autres ressources) mais également en mesure de gérer du contenu PHP.

" />
    <meta name="twitter:image" content="https://vonkrafft.fr/media/2019/02/05b6053c41a2130afd6fc3b158bda4e6.png" />
  




<link rel="canonical" href="/console/simple-site-php-avec-docker-nginx/" />
<link rel="alternative" href="/index.xml" title="vonKrafft" type="application/atom+xml" />


<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="format-detection" content="telephone=no,email=no,adress=no" />
<meta http-equiv="Cache-Control" content="no-transform" />


<meta name="robots" content="index,follow" />




<link rel="shortcut icon" href="/img/favicon.png" type="image/png" />
<link rel="apple-touch-icon" href="/img/apple-touch-icon.png" />
<link rel="apple-touch-icon" sizes="57x57" href="/img/apple-touch-icon-57x57.png" />
<link rel="apple-touch-icon" sizes="72x72" href="/img/apple-touch-icon-72x72.png" />
<link rel="apple-touch-icon" sizes="76x76" href="/img/apple-touch-icon-76x76.png" />
<link rel="apple-touch-icon" sizes="114x114" href="/img/apple-touch-icon-114x114.png" />
<link rel="apple-touch-icon" sizes="120x120" href="/img/apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon" sizes="144x144" href="/img/apple-touch-icon-144x144.png" />
<link rel="apple-touch-icon" sizes="152x152" href="/img/apple-touch-icon-152x152.png" />
<link rel="apple-touch-icon" sizes="180x180" href="/img/apple-touch-icon-180x180.png" />


<link rel="stylesheet" href="/css/bundle.css" />
<link rel="stylesheet" href="/css/font-awesome.min.css" />
<link rel="stylesheet" href="/css/lightbox.css" />
<link rel="stylesheet" href="/css/rajdhani.css" />
<link rel="stylesheet" href="/css/rainbow-wibb.css" />
<link rel="stylesheet" href="/css/wibb.css" />


  
  <!--[if lt IE 9]>
    <script src="/js/html5shiv.min.js"></script>
    <script src="/js/respond.min.js"></script>
    <script src="/js/videojs-ie8.min.js"></script>
  <![endif]-->

<!--[if lte IE 11]>
    <script src="/js/classList.min.js"></script>
  <![endif]-->


<script src="/js/ofi.min.js"></script>


<script src="/js/smooth-scroll.polyfills.min.js"></script>


</head>
  <body>
    
    <div class="suspension">
      <a title="Go to top" class="to-top is-hide"><span class="icon icon-up"></span></a>
      
        
        <a title="Go to comments" class="to-comment" href="#disqus_thread"><span class="icon icon-comment"></span></a>
        
      
    </div>
    
    
  <header class="site-header">
  <a href="/" class="brand"><img class="avatar" src="/img/avatar.jpg" alt="Avatar"></a>
  
  <h2 class="title">von<span class="text-primary">Krafft</span></h2>
  
  <p class="subtitle">Chronicles of a cybersecurity engineer</p>
  <button class="menu-toggle" type="button">
    <span class="icon icon-menu"></span>
  </button>
  <nav class="site-menu collapsed">
    <h2 class="offscreen">Main Menu</h2>
    <ul class="menu-list">
      
      
      
      
      
      
        <li class="menu-item  is-active">
          <a href="/">Blog</a>
          <div class="menu-icon"><i class='fa fa-newspaper-o'></i></div>
          <ul class="menu-sublist">
            
              <li class="menu-subitem menu-actus">
                <a href="/categories/actus/">Actus</a>
              </li>
            
              <li class="menu-subitem menu-dossiers">
                <a href="/categories/dossiers/">Dossiers</a>
              </li>
            
              <li class="menu-subitem menu-guides">
                <a href="/categories/guides/">Guides</a>
              </li>
            
              <li class="menu-subitem menu-tutoriels">
                <a href="/categories/tutoriels/">Tutoriels</a>
              </li>
            
              <li class="menu-subitem menu-console">
                <a href="/categories/console/">Console</a>
              </li>
            
          </ul>
        </li>
      
        <li class="menu-item ">
          <a href="/works/">Works</a>
          <div class="menu-icon"><i class='fa fa-rocket'></i></div>
          <ul class="menu-sublist">
            
          </ul>
        </li>
      
        <li class="menu-item ">
          <a href="/contact/">Contact</a>
          <div class="menu-icon"><i class='fa fa-id-card-o'></i></div>
          <ul class="menu-sublist">
            
          </ul>
        </li>
      
    </ul>
  </nav>
  <nav class="social-menu collapsed">
    <h2 class="offscreen">Social Networks</h2>
  
    <ul class="social-list">
 
     <li class="social-item">
         <a href="mailto:contact%20at%20vonkrafft.fr" title="Email"><span class="icon icon-email"></span></a>
     </li>
 
     <li class="social-item">
         <a href="//github.com/vonKrafft" title="GitHub"><span class="icon icon-github"></span></a>
     </li>
 
     <li class="social-item">
         <a href="//twitter.com/v0nkrafft" title="Twitter"><span class="icon icon-twitter"></span></a>
     </li>
 
     
 
     
 
     
 
     
 
     
 
     
 
     
 
     
 
     
 
     
 
     
 
     
 
     
 
     
 
     <li class="social-item">
         <a href="//www.linkedin.com/in/wandrillekrafft" title="Linkedin"><span class="icon icon-linkedin"></span></a>
     </li>
 
     
 
     
 
     
 
     <li class="social-item">
         <a href="/index.xml"><span class="icon icon-rss" title="RSS"></span></a>
     </li>
 
    </ul>  

  </nav>
</header>

  <section class="main post-detail post-console">
    <header class="post-header">
      <h1 class="post-title">Un simple site en PHP avec Docker et Nginx</h1>
      <p class="post-meta">
        <span class="category"><a href="/categories/console/">Console</a></span>
        @vonKrafft · 25 février 2019
      </p>
    </header>
    <article class="post-content"><p>J&rsquo;ai récemment revu l&rsquo;organisation des containers Docker présents sur mon serveur et j&rsquo;ai essayé d&rsquo;utiliser le plus possible les images &ldquo;officielles&rdquo; des technos dont j&rsquo;avais besoin. Ici, nous allons mettre en place un Nginx pour servir des pages statique (HTML et autres ressources) mais également en mesure de gérer du contenu PHP.</p>

<p></p>

<div class="alert alert-info" role="alert"><i class="fa fa-github"></i> Les fichiers nécessaires et le script de mise en place des containers sont disponibles sur <a href="https://gist.github.com/vonKrafft/5fd248c438711148be878683f6f58b0f">gist.github.com</a>.</div>

<h2 id="objectif-de-l-infra">Objectif de l&rsquo;infra</h2>

<p>Le but est d&rsquo;avoir un container avec Nginx pour servir du contenu statique et dynamique (PHP). Il faudra configurer Nginx pour rediriger les requêtes de ressources PHP vers un second container qui embarquera PHP-FPM (FastCGI Process Manager).</p>

<div class="alert alert-danger" role="alert"><i class="fa fa-exclamation-circle"></i> Je tiens à préciser que le Nginx que nous allons mettre en place sert le contenu en HTTP. Personnellement, j&rsquo;utilise un reverse-proxy qui s&rsquo;occupe de gérer HTTPS (<em>un article futur viendra peut-être pour expliquer comment faire</em>). Si vous comptez mettre en ligne votre site en utilisant Docker et la méthode ci-après, je vous recommande de modifier la configuration du Nginx pour <strong>mettre en place HTTPS</strong>.</div>

<p>Nous aurons donc besoin de deux images Docker :</p>

<ul>
<li><a href="https://hub.docker.com/_/nginx">Nginx</a>, j&rsquo;ai choisi de prendre la version Alpine stable (1.14.2 à la date de cet article) ;</li>
<li><a href="https://hub.docker.com/_/php">PHP-FPM</a>, là encore avec Alpine et avec la dernière version disponible (7.3.2 à la date de cet article).</li>
</ul>

<p>Par préférence personnelle, nous allons utiliser <code>docker-compose</code> pour configurer les containers (<a href="https://docs.docker.com/compose/install/">Installer Docker Compose</a>).</p>

<h2 id="le-container-nginx">Le container Nginx</h2>

<p>Tout d&rsquo;abord, il nous faut créer l’arborescence de répertoire dont nous allons avoir besoin, ainsi que les fichiers de journalisation avec les privilèges adéquats :</p>

<div class="code-container">
	
    <div class="code-title">
        <i class="fa fa-code"></i>
        Console
    </div>
    
    <pre class="code"><code data-language="console">host:~# mkdir -p docker-web/www                  # Webroot dans lequel sera stocké le contenu statique du site
host:~# mkdir -p docker-web/log                  # Pour enregistrer les journaux de Nginx
host:~# touch docker-web/log/{error,access}.log  # Journaux pour Nginx
host:~# chmod a&#43;rw docker-web/log/*              # Accessible en lecture/écriture pour tous (ce n&#39;est pas l&#39;idéal, si quelqu&#39;un a une autre idée je suis preneur)
</code></pre>
</div>

<p>Nous aurons également besoin du fichier de configuration de Nginx. Il remplacera celui par défaut présent dans le container Nginx et permettra de facilement modifier la configuration du serveur sans avoir en entrer dans le container.</p>

<div class="code-container">
	
    <div class="code-title">
        <i class="fa fa-file-text-o"></i>
        docker-web/nginx.conf
    </div>
    
    <pre class="code"><code data-language="nginx">user                       nginx;
worker_processes           1;

error_log                  /var/log/nginx/error.log warn;
pid                        /var/run/nginx.pid;

events {
    worker_connections     1024;
}

http {
    include                /etc/nginx/mime.types;
    default_type           application/octet-stream;
    
    log_format             main  &#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; $status $body_bytes_sent &#34;$http_referer&#34; &#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;;
    access_log             /var/log/nginx/access.log main;
    
    sendfile               on;
    keepalive_timeout      65;
    server_tokens          off;

    server {
        listen             80;
        server_name        localhost;
        
        location / {
            root           /usr/share/nginx/html;
            index          index.html index.htm;
        }
        
        error_page         500 502 503 504 /50x.html;
        location = /50x.html {
            root           /usr/share/nginx/html;
        }
    }
}
</code></pre>
</div>

<p>Pour gérer nos containers, nous allons utiliser <code>docker-compose</code> plutôt que de multiples <code>docker run ...</code>. Docker Compose utilise un fichier de configuration YAML <code>docker-compose.yml</code> dans lequel sont définis nos containers et leurs options de démarrage.</p>

<div class="alert alert-info" role="alert"><i class="fa fa-info-circle"></i> Dans notre cas, le fichier <code>docker-compose.yml</code> et le répertoire <code>docker-web</code> doivent être placés dans le même répertoire parent. Vous pouvez aussi le placer dans un répertoire quelconque et remplacer les chemins relatifs des volumes partagés par des chemins absolus.</div>

<p>On peut à présent configurer et démarrer le container Nginx :</p>

<ul>
<li>Le port TCP/80 (HTTP) est mappé sur l&rsquo;hôte (pour les tests, le port est mappé en local uniquement, veillez si possible à mettre en place du TLS sur le port TCP/443 si vous exposez le serveur sur Internet) ;</li>
<li>Le container est nommé <code>web-nginx</code> ;</li>
<li>Le répertoire <code>./docker-web/www</code> est monté en lecture seule pour y stocker le contenu statique du site Web ;</li>
<li>Le répertoire <code>./docker-web/log</code> est monté pour y stocker les journaux Nginx ;</li>
<li>Le fichier <code>./docker-web/nginx.conf</code> est mappé en lecture seule sur le fichier de configuration Nginx du container.</li>
</ul>

<div class="code-container">
	
    <div class="code-title">
        <i class="fa fa-file-text-o"></i>
        docker-compose.yml
    </div>
    
    <pre class="code"><code data-language="yaml">version: &#39;3&#39;

services:
    web-nginx:
        image: nginx:stable-alpine
        container_name: web-nginx
        volumes:
            - &#34;./docker-web/www:/usr/share/nginx/html:ro&#34;
            - &#34;./docker-web/log:/var/log/nginx&#34;
            - &#34;./docker-web/nginx.conf:/etc/nginx/nginx.conf:ro&#34;
        ports:
            - &#34;127.0.0.1:80:80&#34;
</code></pre>
</div>

<div class="code-container">
	
    <div class="code-title">
        <i class="fa fa-code"></i>
        Console
    </div>
    
    <pre class="code"><code data-language="console">host:~# docker-compose up -d
</code></pre>
</div>

<p>Le site est maintenant accessible sur le port TCP/80 de l&rsquo;hôte, en local. Cependant, si vous vous rendez à l&rsquo;adresse <a href="http://localhost/">http://localhost/</a>, vous obtiendrez une erreur <strong>403 Forbidden</strong> car notre répertoire <code>www</code> est vide. Pour simplement vérifier que tout fonctionne, il suffit de créer un fichier <code>index.html</code> :</p>

<div class="code-container">
	
    <div class="code-title">
        <i class="fa fa-code"></i>
        Console
    </div>
    
    <pre class="code"><code data-language="console">host:~# echo &#39;hello world!&#39; &gt; docker-web/www/index.html
</code></pre>
</div>

<figure>
    <a href="/media/2019/02/fc35fdc70d5fc69d269883a822c7a53e.png" data-lightbox="post-gallery" target="_blank">
        <img src="/media/2019/02/fc35fdc70d5fc69d269883a822c7a53e.png" alt="index.php">
    </a>
    
</figure>

<h2 id="le-container-php">Le container PHP</h2>

<p>Ne perdons pas de vu l&rsquo;objectif : disposer d&rsquo;un environnement Web capable d’interpréter PHP pour servir du contenu dynamique. Pour cela, nous allons mettre en place un second container qui embarquera PHP.</p>

<p>Tout d&rsquo;abord, il faut modifier le fichier de configuration de Nginx pour lui préciser de rediriger les requêtes de ressources PHP vers le container que nous venons de mettre en place. Nous ajoutons <code>index.php</code> dans la directive <code>index</code> du serveur, et les instructions <code>fastcgi</code> pour les fichiers PHP (i.e. les fichiers dont l&rsquo;extension est <strong>.php</strong> : <code>location ~ \.php$</code>).</p>

<div class="code-container">
	
    <div class="code-title">
        <i class="fa fa-file-text-o"></i>
        docker-web/nginx.conf
    </div>
    
    <pre class="code"><code data-language="nginx">user                       nginx;
worker_processes           1;

error_log                  /var/log/nginx/error.log warn;
pid                        /var/run/nginx.pid;

events {
    worker_connections     1024;
}

http {
    include                /etc/nginx/mime.types;
    default_type           application/octet-stream;
    
    log_format             main  &#39;$remote_addr - $remote_user [$time_local] &#34;$request&#34; $status $body_bytes_sent &#34;$http_referer&#34; &#34;$http_user_agent&#34; &#34;$http_x_forwarded_for&#34;&#39;;
    access_log             /var/log/nginx/access.log main;
    
    sendfile               on;
    keepalive_timeout      65;
    server_tokens          off;

    server {
        listen             80;
        server_name        localhost;
        
        location / {
            root           /usr/share/nginx/html;
            index          index.php index.html index.htm;
        }
        
        error_page         500 502 503 504 /50x.html;
        location = /50x.html {
            root           /usr/share/nginx/html;
        }

        location ~ \.php$ {
            root           /usr/share/nginx/html;
            include        fastcgi_params;
            fastcgi_pass   web-php:9000;
            fastcgi_index  index.php;
            fastcgi_param  SCRIPT_FILENAME  /script$fastcgi_script_name;
        }
    }
}
</code></pre>
</div>

<p>Nous aurons besoin également d&rsquo;un fichier <code>index.php</code> afin de pouvoir tester que tout fonctionne une fois que le container sera en place.</p>

<div class="code-container">
	
    <div class="code-title">
        <i class="fa fa-code"></i>
        Console
    </div>
    
    <pre class="code"><code data-language="console">host:~# echo &#39;&lt;?php phpinfo();&#39; &gt; docker-web/www/index.php
</code></pre>
</div>

<p>On peut à présent configurer et démarrer le container PHP :</p>

<ul>
<li>Le container est nommé <code>web-php</code>, ce nom doit être le même que celui utilisé dans le fichier <code>nginx.conf</code> pour la directive <code>fastcgi_pass</code> ;</li>
<li>Le répertoire <code>./docker-web/www</code> est monté en lecture seule pour y stocker les fichiers PHP.</li>
</ul>

<div class="code-container">
	
    <div class="code-title">
        <i class="fa fa-file-text-o"></i>
        docker-compose.yml
    </div>
    
    <pre class="code"><code data-language="yaml">version: &#39;3&#39;

services:
    web-nginx:
        image: nginx:stable-alpine
        container_name: web-nginx
        volumes:
            - &#34;./docker-web/www:/usr/share/nginx/html:ro&#34;
            - &#34;./docker-web/log:/var/log/nginx&#34;
            - &#34;./docker-web/nginx.conf:/etc/nginx/nginx.conf:ro&#34;
        ports:
            - &#34;127.0.0.1:80:80&#34;

    web-php:
        image: php:fpm-alpine
        container_name: web-php
        volumes:
            - &#34;./docker-web/www:/script:ro&#34;
</code></pre>
</div>

<div class="code-container">
	
    <div class="code-title">
        <i class="fa fa-code"></i>
        Console
    </div>
    
    <pre class="code"><code data-language="console">host:~# docker-compose up -d
</code></pre>
</div>

<div class="alert alert-success" role="alert"><i class="fa fa-check-circle"></i> It works!</div>

<figure>
    <a href="/media/2019/02/3be2a3b771431f2096ff984899869fa6.png" data-lightbox="post-gallery" target="_blank">
        <img src="/media/2019/02/3be2a3b771431f2096ff984899869fa6.png" alt="index.php">
    </a>
    
</figure>

<hr />

<h4 id="références">Références</h4>

<ol>
<li><a href="https://hub.docker.com/_/php">PHP (Docker Official Images) - Docker Hub</a></li>
<li><a href="https://hub.docker.com/_/nginx">Nginx (Docker Official Images) - Docker Hub</a></li>
</ol></article>
    <footer class="post-footer">
      
      <ul class="post-tags">
        
          <li><a href="/tags/docker"><span class="tag">Docker</span></a></li>
        
          <li><a href="/tags/php"><span class="tag">PHP</span></a></li>
        
          <li><a href="/tags/nginx"><span class="tag">Nginx</span></a></li>
        
      </ul>
      
      <p class="post-copyright">
        <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Licence Creative Commons" class="img-cc" src="/img/by-sa_4.0_80x15.png" /></a> Cet article est mise à disposition selon les termes de la <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Licence Creative Commons Attribution-ShareAlike 4.0 International</a>. 
      </p>
    </footer>
    
      <div id="disqus_thread"></div>
<script type="text/javascript" src="/js/disqus.js"></script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com/" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    
  </section>
  <footer class="site-footer">
  <p>© 2017-2019 vonKrafft</p>
  <p>Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a>.</p>
</footer>


<script type="text/javascript" src="/js/jquery-3.2.1.min.js"></script>
<script type="text/javascript" src="/js/bundle.js"></script>
<script type="text/javascript" src="/js/lightbox.js"></script>
<script type="text/javascript" src="/js/rainbow.js"></script>

<script type="text/javascript" src="https://www.googletagmanager.com/gtag/js?id=UA-24449159-3" async></script>
<script type="text/javascript" src="/js/gtag.js"></script>



  </body>
</html>
